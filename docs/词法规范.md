# NovaLang 词法规范

本文档定义 NovaLang 的所有词法单元（Token）。

---

## 1. Token 分类总览

| 类别 | 数量 | 说明 |
|------|------|------|
| 关键词 | 68 | 保留字，不可作标识符 |
| 操作符 | 45 | 单字符和多字符操作符 |
| 分隔符 | 12 | 括号、逗号等 |
| 字面量 | 6 | 数字、字符串等 |
| 标识符 | 1 | 用户定义名称 |
| 特殊 | 3 | EOF、换行、注释 |

---

## 2. 关键词（Keywords）

### 2.1 声明关键词
```
val       var       fun       class     interface
object    enum      typealias package   import
module
```

### 2.2 修饰符关键词
```
public    private   protected internal  abstract
sealed    open      override  final     const
inline    crossinline reified operator  vararg
suspend   static    companion
```

### 2.3 控制流关键词
```
if        else      when      for       while
do        return    break     continue  throw
try       catch     finally   guard     use
```

### 2.4 类型操作关键词
```
is        as        in        out       where
```

### 2.5 字面量关键词
```
true      false     null
```

### 2.6 内置类型关键词
```
Any       Unit      Nothing   Int       Long
Float     Double    Boolean   Char      String
Array
```

### 2.7 特殊关键词
```
this      super     it        async     await
launch    scope
```

### 2.8 软关键词（上下文相关，可作标识符）
```
data      builder   singleton lazy      get
set       field     value     init      step
downTo    until     by        constructor
and       or        xor       shl       shr
ushr      inv
```

---

## 3. 操作符（Operators）

### 3.1 算术操作符
| Token | 符号 | 说明 |
|-------|------|------|
| `PLUS` | `+` | 加法/正号 |
| `MINUS` | `-` | 减法/负号 |
| `STAR` | `*` | 乘法/Spread |
| `SLASH` | `/` | 除法 |
| `PERCENT` | `%` | 取余 |
| `PLUS_PLUS` | `++` | 自增 |
| `MINUS_MINUS` | `--` | 自减 |

### 3.2 比较操作符
| Token | 符号 | 说明 |
|-------|------|------|
| `EQ_EQ` | `==` | 相等 |
| `BANG_EQ` | `!=` | 不等 |
| `EQ_EQ_EQ` | `===` | 引用相等 |
| `BANG_EQ_EQ` | `!==` | 引用不等 |
| `LT` | `<` | 小于 |
| `GT` | `>` | 大于 |
| `LT_EQ` | `<=` | 小于等于 |
| `GT_EQ` | `>=` | 大于等于 |

### 3.3 逻辑操作符
| Token | 符号 | 说明 |
|-------|------|------|
| `AMP_AMP` | `&&` | 逻辑与 |
| `PIPE_PIPE` | `\|\|` | 逻辑或 |
| `BANG` | `!` | 逻辑非 |

### 3.4 赋值操作符
| Token | 符号 | 说明 |
|-------|------|------|
| `EQ` | `=` | 赋值 |
| `PLUS_EQ` | `+=` | 加赋值 |
| `MINUS_EQ` | `-=` | 减赋值 |
| `STAR_EQ` | `*=` | 乘赋值 |
| `SLASH_EQ` | `/=` | 除赋值 |
| `PERCENT_EQ` | `%=` | 余赋值 |
| `QUESTION_QUESTION_EQ` | `??=` | 空合并赋值 |
| `PIPE_PIPE_EQ` | `\|\|=` | 或赋值 |
| `AMP_AMP_EQ` | `&&=` | 与赋值 |

### 3.5 空安全操作符
| Token | 符号 | 说明 |
|-------|------|------|
| `QUESTION_DOT` | `?.` | 安全调用 |
| `QUESTION_COLON` | `?:` | Elvis |
| `BANG_BANG` | `!!` | 非空断言 |
| `QUESTION` | `?` | 可空标记/错误传播 |

### 3.6 范围操作符
| Token | 符号 | 说明 |
|-------|------|------|
| `DOT_DOT` | `..` | 闭区间 |
| `DOT_DOT_LT` | `..<` | 半开区间 |

### 3.7 特殊操作符
| Token | 符号 | 说明 |
|-------|------|------|
| `PIPE_GT` | `\|>` | 管道 |
| `COLON_COLON` | `::` | 方法引用 |
| `ARROW` | `->` | Lambda 箭头 |
| `DOUBLE_ARROW` | `=>` | 预留 |
| `UNDERSCORE` | `_` | 占位符/忽略 |
| `AT` | `@` | 注解前缀 |
| `DOLLAR` | `$` | 字符串插值 |
| `HASH` | `#` | Set 字面量前缀 |

---

## 4. 分隔符（Delimiters）

| Token | 符号 | 说明 |
|-------|------|------|
| `LPAREN` | `(` | 左圆括号 |
| `RPAREN` | `)` | 右圆括号 |
| `LBRACE` | `{` | 左花括号 |
| `RBRACE` | `}` | 右花括号 |
| `LBRACKET` | `[` | 左方括号 |
| `RBRACKET` | `]` | 右方括号 |
| `COMMA` | `,` | 逗号 |
| `DOT` | `.` | 点 |
| `COLON` | `:` | 冒号 |
| `SEMICOLON` | `;` | 分号（可选） |
| `NEWLINE` | `\n` | 换行（语句分隔） |

---

## 5. 字面量（Literals）

### 5.1 整数字面量
```
TOKEN: INT_LITERAL
规则: [0-9]+ | 0x[0-9a-fA-F]+ | 0b[01]+ | 0o[0-7]+
后缀: L (Long)
示例: 42, 0xFF, 0b1010, 0o755, 100L
```

### 5.2 浮点字面量
```
TOKEN: FLOAT_LITERAL
规则: [0-9]+\.[0-9]+ ([eE][+-]?[0-9]+)?
后缀: f/F (Float), 无后缀为 Double
示例: 3.14, 2.5e10, 1.0f
```

### 5.3 字符字面量
```
TOKEN: CHAR_LITERAL
规则: '[^'\\]' | '\\[trnbf'"\\]' | '\\u[0-9a-fA-F]{4}'
示例: 'A', '\n', '\u0041'
```

### 5.4 字符串字面量
```
TOKEN: STRING_LITERAL
规则: "[^"\\]*" (支持转义和插值)
插值: $identifier 或 ${expression}
示例: "hello", "count: $n", "sum: ${a + b}"

TOKEN: RAW_STRING_LITERAL
规则: r"[^"]*" (不转义)
示例: r"\d+\.\d+"

TOKEN: MULTILINE_STRING_LITERAL
规则: """...""" (多行，支持插值)
示例: """
      line1
      line2
      """
```

### 5.5 标识符
```
TOKEN: IDENTIFIER
规则: [a-zA-Z_][a-zA-Z0-9_]*
反引号: `any identifier` (允许关键词作标识符)
示例: name, _private, MyClass, `class`
```

---

## 6. 注释（Comments）

```
// 单行注释
TOKEN: LINE_COMMENT
规则: //[^\n]*

/* 多行注释 */
TOKEN: BLOCK_COMMENT
规则: /\*.*?\*/ (非贪婪，支持嵌套)

/** 文档注释 */
TOKEN: DOC_COMMENT
规则: /\*\*.*?\*/
```

---

## 7. 词法优先级与歧义处理

### 7.1 最长匹配原则
```
// "===" 优先于 "==" + "="
a === b  →  [IDENTIFIER:a] [EQ_EQ_EQ] [IDENTIFIER:b]

// "..<" 优先于 ".." + "<"
1..<10   →  [INT:1] [DOT_DOT_LT] [INT:10]
```

### 7.2 关键词优先于标识符
```
class  →  [KW_CLASS]    // 关键词
classy →  [IDENTIFIER]  // 标识符
```

### 7.3 数字后缀处理
```
42L    →  [LONG_LITERAL:42]
3.14f  →  [FLOAT_LITERAL:3.14]
```

---

## 8. 换行与语句分隔

NovaLang 采用**可选分号**策略：

### 8.1 自动分号插入规则
在以下情况，换行被视为语句结束：
1. 当前行以表达式/声明结束
2. 下一行以不能继续当前语句的 Token 开始

```nova
val a = 1      // 换行 → 语句结束
val b = 2

val c = 1 +    // 换行不结束（+ 期待操作数）
    2          // 继续上一行
```

### 8.2 显式续行
```nova
val long = someVeryLongExpression \
    .chainedCall() \
    .anotherCall()
```

### 8.3 不插入分号的 Token
下一行以这些 Token 开始时，不插入分号：
```
.  ?.  (  [  {  +  -  *  /  %  &&  ||  |>
```

---

## 9. Token 定义（Java 枚举）

```java
public enum TokenType {
    // === 字面量 ===
    INT_LITERAL,
    LONG_LITERAL,
    FLOAT_LITERAL,
    DOUBLE_LITERAL,
    CHAR_LITERAL,
    STRING_LITERAL,
    RAW_STRING_LITERAL,
    MULTILINE_STRING_LITERAL,

    // === 标识符 ===
    IDENTIFIER,

    // === 关键词 - 声明 ===
    KW_VAL, KW_VAR, KW_FUN, KW_CLASS, KW_INTERFACE,
    KW_OBJECT, KW_ENUM, KW_TYPEALIAS, KW_PACKAGE, KW_IMPORT,
    KW_MODULE,

    // === 关键词 - 修饰符 ===
    KW_PUBLIC, KW_PRIVATE, KW_PROTECTED, KW_INTERNAL,
    KW_ABSTRACT, KW_SEALED, KW_OPEN, KW_OVERRIDE, KW_FINAL,
    KW_CONST, KW_INLINE, KW_CROSSINLINE, KW_REIFIED,
    KW_OPERATOR, KW_VARARG, KW_SUSPEND, KW_STATIC, KW_COMPANION,

    // === 关键词 - 控制流 ===
    KW_IF, KW_ELSE, KW_WHEN, KW_FOR, KW_WHILE,
    KW_DO, KW_RETURN, KW_BREAK, KW_CONTINUE, KW_THROW,
    KW_TRY, KW_CATCH, KW_FINALLY, KW_GUARD, KW_USE,

    // === 关键词 - 类型 ===
    KW_IS, KW_AS, KW_IN, KW_OUT, KW_WHERE,
    KW_TRUE, KW_FALSE, KW_NULL,

    // === 关键词 - 内置类型 ===
    KW_ANY, KW_UNIT, KW_NOTHING,
    KW_INT, KW_LONG, KW_FLOAT, KW_DOUBLE,
    KW_BOOLEAN, KW_CHAR, KW_STRING, KW_ARRAY,

    // === 关键词 - 特殊 ===
    KW_THIS, KW_SUPER, KW_IT, KW_ASYNC, KW_AWAIT,
    KW_LAUNCH, KW_SCOPE,

    // === 操作符 - 算术 ===
    PLUS, MINUS, STAR, SLASH, PERCENT,
    PLUS_PLUS, MINUS_MINUS,

    // === 操作符 - 比较 ===
    EQ_EQ, BANG_EQ, EQ_EQ_EQ, BANG_EQ_EQ,
    LT, GT, LT_EQ, GT_EQ,

    // === 操作符 - 逻辑 ===
    AMP_AMP, PIPE_PIPE, BANG,

    // === 操作符 - 赋值 ===
    EQ, PLUS_EQ, MINUS_EQ, STAR_EQ, SLASH_EQ, PERCENT_EQ,
    QUESTION_QUESTION_EQ, PIPE_PIPE_EQ, AMP_AMP_EQ,

    // === 操作符 - 空安全 ===
    QUESTION, QUESTION_DOT, QUESTION_COLON, BANG_BANG,

    // === 操作符 - 范围 ===
    DOT_DOT, DOT_DOT_LT,

    // === 操作符 - 特殊 ===
    PIPE_GT, COLON_COLON, ARROW, DOUBLE_ARROW,
    UNDERSCORE, AT, DOLLAR, HASH,

    // === 分隔符 ===
    LPAREN, RPAREN, LBRACE, RBRACE, LBRACKET, RBRACKET,
    COMMA, DOT, COLON, SEMICOLON,

    // === 特殊 ===
    NEWLINE,
    EOF,

    // === 错误 ===
    ERROR
}
```

---

## 10. 关键词映射表

```java
// JDK 8 兼容：使用静态初始化块
private static final Map<String, TokenType> KEYWORDS;

static {
    Map<String, TokenType> map = new HashMap<>();

    // 声明
    map.put("val", KW_VAL);
    map.put("var", KW_VAR);
    map.put("fun", KW_FUN);
    map.put("class", KW_CLASS);
    map.put("interface", KW_INTERFACE);
    map.put("object", KW_OBJECT);
    map.put("enum", KW_ENUM);
    map.put("typealias", KW_TYPEALIAS);
    map.put("package", KW_PACKAGE);
    map.put("import", KW_IMPORT);
    map.put("module", KW_MODULE);

    // 修饰符
    map.put("public", KW_PUBLIC);
    map.put("private", KW_PRIVATE);
    map.put("protected", KW_PROTECTED);
    map.put("internal", KW_INTERNAL);
    map.put("abstract", KW_ABSTRACT);
    map.put("sealed", KW_SEALED);
    map.put("open", KW_OPEN);
    map.put("override", KW_OVERRIDE);
    map.put("final", KW_FINAL);
    map.put("const", KW_CONST);
    map.put("inline", KW_INLINE);
    map.put("crossinline", KW_CROSSINLINE);
    map.put("reified", KW_REIFIED);
    map.put("operator", KW_OPERATOR);
    map.put("vararg", KW_VARARG);
    map.put("suspend", KW_SUSPEND);
    map.put("static", KW_STATIC);
    map.put("companion", KW_COMPANION);

    // 控制流
    map.put("if", KW_IF);
    map.put("else", KW_ELSE);
    map.put("when", KW_WHEN);
    map.put("for", KW_FOR);
    map.put("while", KW_WHILE);
    map.put("do", KW_DO);
    map.put("return", KW_RETURN);
    map.put("break", KW_BREAK);
    map.put("continue", KW_CONTINUE);
    map.put("throw", KW_THROW);
    map.put("try", KW_TRY);
    map.put("catch", KW_CATCH);
    map.put("finally", KW_FINALLY);
    map.put("guard", KW_GUARD);
    map.put("use", KW_USE);

    // 类型
    map.put("is", KW_IS);
    map.put("as", KW_AS);
    map.put("in", KW_IN);
    map.put("out", KW_OUT);
    map.put("where", KW_WHERE);
    map.put("true", KW_TRUE);
    map.put("false", KW_FALSE);
    map.put("null", KW_NULL);

    // 内置类型
    map.put("Any", KW_ANY);
    map.put("Unit", KW_UNIT);
    map.put("Nothing", KW_NOTHING);
    map.put("Int", KW_INT);
    map.put("Long", KW_LONG);
    map.put("Float", KW_FLOAT);
    map.put("Double", KW_DOUBLE);
    map.put("Boolean", KW_BOOLEAN);
    map.put("Char", KW_CHAR);
    map.put("String", KW_STRING);
    map.put("Array", KW_ARRAY);

    // 特殊
    map.put("this", KW_THIS);
    map.put("super", KW_SUPER);
    map.put("it", KW_IT);
    map.put("async", KW_ASYNC);
    map.put("await", KW_AWAIT);
    map.put("launch", KW_LAUNCH);
    map.put("scope", KW_SCOPE);

    KEYWORDS = Collections.unmodifiableMap(map);
}
```

---

*NovaLang 词法规范 v1.0*
