# NovaLang 语法文档

## 字面量

### 整数

```nova
val dec = 42            // 十进制
val hex = 0xFF          // 十六进制
val bin = 0b1010        // 二进制
val oct = 0o77          // 八进制
val long = 100L         // Long 类型
```

### 浮点数

```nova
val d = 3.14            // Double
val f = 2.5f            // Float
```

### 字符

```nova
val ch = 'A'
val newline = '\n'
val unicode = '\u0041'  // 'A'
```

### 字符串

```nova
// 普通字符串
val s = "Hello, World!"

// 字符串插值
val name = "Nova"
val msg = "Hello, $name!"              // 简单变量
val expr = "Result: ${1 + 2}"          // 表达式

// 原始字符串（不转义反斜杠）
val path = r"C:\Users\Admin\Documents"
val regex = r"\d{3}-\d{4}"

// 多行字符串
val sql = """
    SELECT *
    FROM users
    WHERE age > 18
"""
```

### 布尔值

```nova
val t = true
val f = false
```

### 空值

```nova
val nothing = null
```

## 变量声明

### val 和 var

```nova
val immutable = 42     // 不可变变量（赋值后不能修改）
var mutable = 0        // 可变变量
mutable = 10           // OK
// immutable = 10      // 错误！val 不可重新赋值
```

### 类型注解

```nova
val name: String = "Alice"
var count: Int = 0
val list: List = [1, 2, 3]
```

### 解构声明

```nova
// 列表解构
val (a, b, c) = [1, 2, 3]

// 跳过元素
val (first, _, third) = [1, 2, 3]

// 对象解构（需要 componentN 方法）
@data class Point(val x: Int, val y: Int)
val (x, y) = Point(3, 4)

// for 循环中解构
val pairs = [[1, "a"], [2, "b"]]
for ((num, str) in pairs) {
    println("$num -> $str")
}
```

## 函数

### 基本函数

```nova
fun greet(name: String): String {
    return "Hello, $name!"
}
```

### 表达式体函数

```nova
fun double(x: Int) = x * 2
fun max(a: Int, b: Int) = if (a > b) a else b
```

### 默认参数

```nova
fun greet(name: String, greeting: String = "Hello") {
    println("$greeting, $name!")
}

greet("Alice")            // Hello, Alice!
greet("Bob", "Hi")        // Hi, Bob!
```

### 可变参数（vararg）

```nova
fun sum(vararg numbers: Int): Int {
    var total = 0
    for (n in numbers) {
        total = total + n
    }
    return total
}

sum(1, 2, 3)    // 6
```

### 泛型函数

```nova
fun <T> identity(value: T): T = value
fun <T> listOfSingle(item: T): List = listOf(item)
```

### 扩展函数

为已有类型添加方法，无需修改原类型：

```nova
fun String.exclaim() = this + "!"
fun Int.isEven() = this % 2 == 0

"Hello".exclaim()    // "Hello!"
4.isEven()           // true
```

### 扩展属性

```nova
val String.wordCount = this.split(" ").size()

"Hello Nova World".wordCount  // 3
```

### 中缀函数

```nova
infix fun Int.power(exp: Int): Int {
    var result = 1
    for (i in 1..exp) { result = result * this }
    return result
}

2 power 10  // 1024
```

## 类与对象

### 类定义

```nova
class Person(val name: String, var age: Int) {
    fun greet() = "Hi, I'm $name, $age years old"

    fun toString() = "Person($name, $age)"
}

val p = Person("Alice", 30)
println(p.greet())      // Hi, I'm Alice, 30 years old
println(p.name)         // Alice
p.age = 31              // var 属性可修改
```

### 初始化块

`init { ... }` 块在实例创建时执行，可访问主构造器参数和前面已声明的属性。一个类中允许多个 init 块，它们与属性初始化器按声明顺序交织执行。

```nova
class Validator(val value: Int) {
    init {
        require(value >= 0, "Value must be non-negative")
    }
}
```

多个 init 块与属性初始化器按声明顺序执行：

```nova
class Foo(val x: Int) {
    val a = x + 1
    init { println("a = $a") }       // 可访问 x 和 a
    val b = a * 2
    init { println("b = $b") }       // 可访问 x, a, b
}

val f = Foo(3)
// 输出:
// a = 4
// b = 8
```

init 块中可使用控制流和调用方法：

```nova
class Config(val port: Int) {
    var status = ""
    init {
        if (port > 0) {
            status = "valid"
        } else {
            status = "invalid"
        }
    }
}
```

无主构造器参数的类也可使用 init 块：

```nova
class Counter {
    var count = 0
    init {
        count = 100
    }
}
```

次级构造器委托到主构造器时，init 块由主构造器触发：

```nova
class Point(val x: Int, val y: Int) {
    init { println("Point($x, $y)") }
    constructor(v: Int) : this(v, v)
}

val p = Point(5)   // 输出: Point(5, 5)
```

### 次级构造器

```nova
class Rectangle(val width: Int, val height: Int) {
    constructor(size: Int) : this(size, size)  // 委托到主构造器
}

val square = Rectangle(5)     // 使用次级构造器
val rect = Rectangle(3, 4)    // 使用主构造器
```

### 继承

```nova
open class Animal(val name: String) {
    open fun speak() = "$name makes a sound"
}

class Dog(name: String) : Animal(name) {
    fun speak() = "$name says Woof!"
}

val dog = Dog("Rex")
println(dog.speak())    // Rex says Woof!
```

### 抽象类

```nova
abstract class Shape {
    abstract fun area(): Double
}

class Circle(val radius: Double) : Shape() {
    fun area() = PI * radius * radius
}
```

### 密封类

```nova
sealed class Result
class Success(val data: String) : Result()
class Error(val message: String) : Result()
```

### 接口

```nova
interface Printable {
    fun print()
}

interface Named {
    fun name(): String
    // 默认方法
    fun displayName() = "[${name()}]"
}

class User(val username: String) : Printable, Named {
    fun print() = println("User: $username")
    fun name() = username
}
```

### 枚举类

```nova
enum class Color {
    RED, GREEN, BLUE
}

val c = Color.RED
println(c.name)       // "RED"
println(c.ordinal)    // 0
```

带属性和方法的枚举：

```nova
enum class Planet(val mass: Double, val radius: Double) {
    EARTH(5.976e24, 6.37814e6),
    MARS(6.421e23, 3.3972e6);

    fun surfaceGravity() = 6.67300e-11 * mass / (radius * radius)
}
```

### Data Class（@data 注解）

自动生成 `toString`、`equals`、`hashCode`、`copy`、`componentN` 方法：

```nova
@data class User(val name: String, val age: Int)

val user = User("Alice", 30)
println(user)                          // User(name=Alice, age=30)
val older = user.copy(age = 31)        // User(name=Alice, age=31)
val (name, age) = user                 // 解构
```

### 注解类

```nova
annotation class Serializable
annotation class JsonName(val name: String)

@Serializable
@JsonName(name = "user_config")
class Config(val host: String, val port: Int)

// 运行时查询注解
Config.annotations  // [{name: "Serializable", args: {}}, {name: "JsonName", args: {name: "user_config"}}]
```

### 单例对象

```nova
object Database {
    val connection = "localhost:5432"
    fun query(sql: String) = "Executing: $sql"
}

println(Database.connection)
Database.query("SELECT * FROM users")
```

### 伴生对象

```nova
class User(val name: String) {
    companion object {
        val DEFAULT_NAME = "Anonymous"
        fun create(name: String) = User(name)
    }
}

val user = User.create("Alice")
println(User.DEFAULT_NAME)
```

### 匿名对象

```nova
interface Listener {
    fun onClick()
}

val listener = object : Listener {
    fun onClick() {
        println("Clicked!")
    }
}
```

### 可见性修饰符

| 修饰符 | 说明 |
|--------|------|
| `public` | 对所有类可见（默认） |
| `private` | 仅当前类内部可见 |
| `protected` | 当前类及子类可见 |
| `internal` | 当前模块内可见 |

```nova
class Account(private val balance: Int) {
    fun getBalance() = balance  // 通过公共方法访问

    private fun validate() { /* ... */ }
}

val acc = Account(100)
println(acc.getBalance())   // OK
// acc.balance              // 错误！private 字段
```

## 控制流

### if-else

作为语句或表达式使用：

```nova
// 语句
if (x > 0) {
    println("positive")
} else if (x < 0) {
    println("negative")
} else {
    println("zero")
}

// 表达式
val result = if (x > 0) "positive" else "negative"
```

### when 表达式

```nova
// 值匹配
when (x) {
    1 -> "one"
    2 -> "two"
    3, 4 -> "three or four"
    in 5..10 -> "between 5 and 10"
    else -> "other"
}

// 类型匹配
when (obj) {
    is String -> "String of length ${obj.length()}"
    is Int -> "Int: $obj"
    is List -> "List of size ${obj.size()}"
    else -> "Unknown"
}

// 无参 when（替代 if-else if 链）
when {
    x < 0 -> "negative"
    x == 0 -> "zero"
    else -> "positive"
}
```

### for 循环

```nova
// 遍历范围
for (i in 1..5) {
    println(i)
}

// 半开区间
for (i in 0..<10) {
    println(i)   // 0 到 9
}

// 带步长
for (i in 0..20 step 5) {
    println(i)   // 0, 5, 10, 15, 20
}

// 遍历列表
for (item in [1, 2, 3]) {
    println(item)
}

// 解构遍历
for ((key, value) in #{"a": 1, "b": 2}) {
    println("$key = $value")
}
```

### while 和 do-while

```nova
var i = 0
while (i < 5) {
    println(i)
    i = i + 1
}

do {
    val input = readLine()
} while (input != "quit")
```

### try-catch-finally

```nova
try {
    val result = 10 / 0
} catch (e) {
    println("Error: $e")
} finally {
    println("Cleanup")
}

// 作为表达式
val result = try { toInt("abc") } catch (e) { -1 }
```

### break 和 continue

```nova
for (i in 1..10) {
    if (i == 5) break       // 跳出循环
    if (i % 2 == 0) continue // 跳过偶数
    println(i)
}
```

### 标签化的 break/continue/return

```nova
outer@ for (i in 1..5) {
    for (j in 1..5) {
        if (i * j > 10) break@outer  // 跳出外层循环
    }
}

fun processItems(items: List) {
    items.forEach lit@ { item ->
        if (item == null) return@lit  // 跳过当前 Lambda 迭代
        println(item)
    }
}
```

### guard 语句

安全解包，null 时执行 else 分支（必须包含 return/throw/break/continue）：

```nova
fun process(value: Int?): Int {
    guard val x = value else { return -1 }
    return x * 2
}

process(5)      // 10
process(null)   // -1
```

### use 语句

类似 try-with-resources，自动关闭资源：

```nova
use (val reader = openFile("data.txt")) {
    val content = reader.readLines()
    println(content)
}
// reader 在此自动关闭

// 多资源
use (val conn = getConnection(), val stmt = conn.createStatement()) {
    stmt.execute("SELECT * FROM users")
}
```

## 表达式

### 运算符

#### 算术运算符

| 运算符 | 说明 |
|--------|------|
| `+` `-` `*` `/` `%` | 加、减、乘、除、取余 |
| `-x` | 一元负号 |
| `+x` | 一元正号 |
| `++x` `x++` | 自增 |
| `--x` `x--` | 自减 |

#### 比较运算符

| 运算符 | 说明 |
|--------|------|
| `==` `!=` | 结构相等/不等 |
| `===` `!==` | 引用相等/不等 |
| `<` `>` `<=` `>=` | 大小比较 |

#### 逻辑运算符

| 运算符 | 说明 |
|--------|------|
| `&&` | 逻辑与（短路求值） |
| `\|\|` | 逻辑或（短路求值） |
| `!` | 逻辑非 |

#### 赋值运算符

| 运算符 | 说明 |
|--------|------|
| `=` | 赋值 |
| `+=` `-=` `*=` `/=` `%=` | 复合赋值 |
| `??=` | 空值合并赋值（仅当变量为 null 时赋值） |
| `\|\|=` | 逻辑或赋值（仅当变量为 falsy 时赋值） |
| `&&=` | 逻辑与赋值（仅当变量为 truthy 时赋值） |

```nova
var x: Int? = null
x ??= 42          // x = 42（因为 x 是 null）
x ??= 100         // x = 42（不变，因为 x 已非 null）
```

### 空安全

| 运算符 | 说明 |
|--------|------|
| `?.` | 安全调用（null 时返回 null） |
| `?[]` | 安全索引（null 时返回 null） |
| `?:` | Elvis 运算符（null 时使用默认值） |
| `!!` | 非空断言（null 时抛出异常） |

```nova
val name: String? = null
name?.length()         // null（不会抛异常）
name ?: "Unknown"      // "Unknown"
// name!!              // 抛出异常

val list: List? = null
list?[0]               // null
```

### 类型操作

| 运算符 | 说明 |
|--------|------|
| `is` | 类型检查 |
| `!is` | 类型否定检查 |
| `as` | 类型转换（失败抛异常） |
| `as?` | 安全类型转换（失败返回 null） |

```nova
if (obj is String) {
    println(obj.length())  // 智能转换
}

val s = obj as? String     // 安全转换，失败返回 null
```

### 范围表达式

```nova
val closed = 1..10       // 闭区间 [1, 10]
val halfOpen = 0..<10    // 半开区间 [0, 10)
val stepped = 1..20 step 3  // 1, 4, 7, 10, 13, 16, 19
```

### Lambda 表达式

```nova
// 基本 Lambda
val square = { x -> x * x }
square(5)  // 25

// 多参数
val add = { a, b -> a + b }
add(3, 4)  // 7

// 隐式 it 参数（单参数 Lambda）
val double = { it * 2 }
double(5)  // 10

// 无参数
val hello = { println("Hello!") }
hello()
```

### 尾随 Lambda

当最后一个参数是 Lambda 时，可以放在括号外：

```nova
list.forEach { println(it) }
list.filter { it > 5 }.map { it * 2 }

// 仅有 Lambda 参数时可省略括号
run { println("Hello") }
```

### 方法引用

```nova
// 全局函数引用
fun double(x: Int) = x * 2
val ref = ::double
[1, 2, 3].map(::double)    // [2, 4, 6]

// 实例方法引用
val str = "Hello"
val fn = str::length

// 构造器引用
class Point(val x: Int, val y: Int)
val create = Point::new
val p = create(3, 4)
```

### 管道运算符

将左侧值作为第一个参数传入右侧函数：

```nova
fun double(x: Int) = x * 2
fun add1(x: Int) = x + 1

5 |> add1 |> double    // 12 等价于 double(add1(5))
10 |> add(5)           // 15（部分应用）
5 |> { x -> x * x }   // 25（管道到 Lambda）
```

### 集合字面量

```nova
// 列表
val list = [1, 2, 3, 4, 5]

// Map
val map = #{"name": "Alice", "age": 30}
val map2 = #{1: "one", 2: "two"}
```

### 字符串插值

```nova
val name = "Nova"
val age = 5
println("$name is $age years old")            // 简单变量
println("${name.toUpperCase()} has ${name.length()} chars")  // 表达式
```

### 索引和切片

```nova
val list = [10, 20, 30, 40, 50]
list[0]         // 10
list[-1]        // 50（负索引，从末尾开始）
list[1..3]      // [20, 30, 40]（切片）

val str = "Hello"
str[0]          // 'H'
```

### 展开运算符

```nova
val list = [1, 2, 3]
val expanded = [0, ..list, 4]  // [0, 1, 2, 3, 4]
```

### 链式比较

```nova
1 < 2 < 3         // true，等价于 1 < 2 && 2 < 3
0 <= x < 10        // 范围检查
5 == 5 == 5        // true
```

### 作用域简写

在安全调用后直接使用块访问成员：

```nova
val user = getUser()
user?.{
    println(name)    // 直接访问 user 的字段
    println(age)
}
```

## 运算符重载

通过定义约定方法名来重载运算符：

| 运算符 | 方法名 |
|--------|--------|
| `a + b` | `plus(other)` |
| `a - b` | `minus(other)` |
| `a * b` | `times(other)` |
| `a / b` | `div(other)` |
| `a % b` | `rem(other)` |
| `-a` | `unaryMinus()` |
| `+a` | `unaryPlus()` |
| `a++` | `inc()` |
| `a--` | `dec()` |
| `a[i]` | `get(index)` |
| `a[i] = v` | `set(index, value)` |
| `a < b` 等 | `compareTo(other)` |

```nova
class Vec2(val x: Double, val y: Double) {
    fun plus(other: Vec2) = Vec2(x + other.x, y + other.y)
    fun minus(other: Vec2) = Vec2(x - other.x, y - other.y)
    fun times(scalar: Double) = Vec2(x * scalar, y * scalar)
    fun unaryMinus() = Vec2(-x, -y)
    fun toString() = "($x, $y)"
}

val a = Vec2(1.0, 2.0)
val b = Vec2(3.0, 4.0)
println(a + b)       // (4.0, 6.0)
println(a * 2.0)     // (2.0, 4.0)
println(-a)          // (-1.0, -2.0)
```

`compareTo` 返回 Int（<0, 0, >0），自动支持 `<`、`>`、`<=`、`>=`：

```nova
class Version(val major: Int, val minor: Int) {
    fun compareTo(other: Version): Int {
        val diff = major - other.major
        if (diff != 0) return diff
        return minor - other.minor
    }
}

Version(2, 0) > Version(1, 9)   // true
```

## 注解系统

### 定义注解

```nova
annotation class Deprecated
annotation class JsonName(val name: String)
annotation class Range(val min: Int, val max: Int)
```

### 使用注解

```nova
@Deprecated
@JsonName(name = "user_name")
class User(val name: String, val age: Int)
```

### 运行时查询

```nova
User.annotations
// [{name: "Deprecated", args: {}}, {name: "JsonName", args: {name: "user_name"}}]
```

### 注册注解处理器

```nova
registerAnnotationProcessor("MyAnnotation") { target, args ->
    // target 是被注解的类或函数
    // args 是注解参数的 Map
    println("Processing ${target} with args ${args}")
}
```

### 内置注解

| 注解 | 说明 |
|------|------|
| `@data` | 自动生成 toString、equals、hashCode、copy、componentN |
| `@builder` | 自动生成 Builder 模式代码 |

## 类型系统

### 基础类型

| 类型 | 说明 |
|------|------|
| `Int` | 32 位整数 |
| `Long` | 64 位整数 |
| `Double` | 64 位浮点数 |
| `Float` | 32 位浮点数 |
| `Boolean` | 布尔值 |
| `Char` | 字符 |
| `String` | 字符串 |

### 可空类型

在类型后加 `?` 表示可空：

```nova
var name: String? = null
name = "Alice"
name = null   // OK

var count: Int = 0
// count = null  // 错误！非空类型
```

### 泛型

```nova
class Box<T>(val value: T) {
    fun get(): T = value
}

val intBox = Box(42)
val strBox = Box("Hello")
```

### 函数类型

```nova
val operation: (Int, Int) -> Int = { a, b -> a + b }
fun apply(x: Int, f: (Int) -> Int): Int = f(x)
```
