name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew build -x test

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Prepare release assets
        run: |
          mkdir -p release
          VERSION=${{ steps.get_version.outputs.VERSION }}

          # CLI (fat jar，可直接运行)
          cp nova-cli/build/libs/nova-cli-*.jar release/nova-cli-${VERSION}.jar

          # Runtime (fat jar，包含所有依赖和 JSR-223 支持)
          cp nova-runtime/build/libs/*-with-dependencies.jar release/nova-runtime-${VERSION}.jar

          # Bukkit (瘦包，轻量级适配器)
          find nova-bukkit/build/libs -name "nova-bukkit-*.jar" ! -name "*-with-dependencies.jar" -exec cp {} release/nova-bukkit-${VERSION}.jar \;

          echo "Release assets:"
          ls -la release/

      - name: Generate changelog
        id: changelog
        run: |
          # 找到上一个 tag
          PREV_TAG=$(git tag --sort=-version:refname | grep '^v' | sed -n '2p')
          if [ -z "$PREV_TAG" ]; then
            # 没有上一个 tag，取所有 commit
            LOG=$(git log --pretty=format:"- %s (%h)" HEAD)
          else
            LOG=$(git log --pretty=format:"- %s (%h)" ${PREV_TAG}..HEAD)
          fi
          # 写入文件避免多行转义问题
          echo "$LOG" > /tmp/changelog.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: NovaLang ${{ steps.get_version.outputs.VERSION }}
          body_path: /tmp/changelog.txt
          append_body: true
          generate_release_notes: false
          files: release/*
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
